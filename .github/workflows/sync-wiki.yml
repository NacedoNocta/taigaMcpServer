name: ðŸ”„ Sync Docs to Wiki

on:
  push:
    branches: [main]
    paths: ['docs/**']
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    name: ðŸ“š Sync Documentation to Wiki
    
    steps:
      - name: ðŸ“¥ Checkout Main Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ“¥ Checkout Wiki Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          token: ${{ secrets.GITHUB_TOKEN }}
          path: wiki
          
      - name: ðŸ§¹ Clean Wiki Directory
        run: |
          # ä¿ç•™ .git ç›®å½•ï¼Œæ¸…ç†å…¶ä»–æ–‡ä»¶
          find wiki -type f -not -path 'wiki/.git/*' -delete
          
      - name: ðŸ”„ Copy Documentation Files
        run: |
          # å¤åˆ¶æ‰€æœ‰ docs/ ä¸‹çš„ .md æ–‡ä»¶åˆ° wiki ç›®å½•
          cp docs/*.md wiki/ 2>/dev/null || true
          
          # ç¡®ä¿å…³é”®æ–‡ä»¶å­˜åœ¨
          if [ ! -f "wiki/Home.md" ] && [ -f "docs/Home.md" ]; then
            cp docs/Home.md wiki/Home.md
          fi
          
          if [ ! -f "wiki/_Sidebar.md" ] && [ -f "docs/_Sidebar.md" ]; then
            cp docs/_Sidebar.md wiki/_Sidebar.md
          fi
          
      - name: ðŸ”— Fix Internal Links for Wiki Format
        run: |
          cd wiki
          
          # ä¿®å¤ Wiki å†…éƒ¨é“¾æŽ¥æ ¼å¼
          for file in *.md; do
            if [ -f "$file" ]; then
              echo "Processing $file..."
              
              # æ›¿æ¢ç›¸å¯¹è·¯å¾„é“¾æŽ¥ä¸º Wiki é“¾æŽ¥æ ¼å¼
              sed -i 's/\](getting-started\/installation\.md)/](Installation-Guide)/g' "$file"
              sed -i 's/\](getting-started\/configuration\.md)/](Configuration)/g' "$file"
              sed -i 's/\](getting-started\/first-steps\.md)/](First-Steps)/g' "$file"
              sed -i 's/\](api\/README\.md)/](API-Reference)/g' "$file"
              sed -i 's/\](guides\/ci-cd\.md)/](CI-CD-Guide)/g' "$file"
              sed -i 's/\](architecture\/overview\.md)/](Architecture-Overview)/g' "$file"
              sed -i 's/\](architecture\/design\.md)/](Design)/g' "$file"
              
              # ä¿®å¤ docs/ æ ¹ç›®å½•çš„é“¾æŽ¥
              sed -i 's/\](README\.md)/](Home)/g' "$file"
              sed -i 's/\](Home\.md)/](Home)/g' "$file"
              
              # ç¡®ä¿ [[WikiLink]] æ ¼å¼æ­£ç¡®
              sed -i 's/\[\[Installation Guide\]\]/[[Installation-Guide|å®‰è£…æŒ‡å—]]/g' "$file"
              sed -i 's/\[\[API Reference\]\]/[[API-Reference|API å‚è€ƒ]]/g' "$file"
              sed -i 's/\[\[CI CD Guide\]\]/[[CI-CD-Guide|CI/CD æŒ‡å—]]/g' "$file"
            fi
          done
          
      - name: ðŸ“ Generate Wiki Summary
        run: |
          cd wiki
          
          echo "ðŸ“Š WikiåŒæ­¥ç»Ÿè®¡:" > sync-summary.txt
          echo "- åŒæ­¥æ—¶é—´: $(date)" >> sync-summary.txt
          echo "- æ–‡ä»¶æ•°é‡: $(ls -1 *.md 2>/dev/null | wc -l)" >> sync-summary.txt
          echo "- åŒæ­¥æ–‡ä»¶:" >> sync-summary.txt
          ls -1 *.md 2>/dev/null | sed 's/^/  - /' >> sync-summary.txt
          
          cat sync-summary.txt
          
      - name: ðŸ’¾ Commit Wiki Changes
        run: |
          cd wiki
          
          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ æ£€æµ‹åˆ°æ–‡æ¡£æ›´æ”¹ï¼Œå¼€å§‹æäº¤..."
            
            git add .
            git commit -m "ðŸ”„ Auto-sync from docs/ directory

ðŸ“š Documentation Sync:
- Synced from main repository docs/ directory
- Updated $(date)
- Fixed internal links for Wiki format
- Maintained all documentation structure

ðŸ¤– Auto-generated by GitHub Actions
ðŸ“… Commit: ${GITHUB_SHA:0:7}
ðŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            echo "ðŸš€ æŽ¨é€æ›´æ”¹åˆ° Wiki..."
            git push origin master
            echo "âœ… Wiki åŒæ­¥å®Œæˆ!"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡æ¡£æ›´æ”¹ï¼Œè·³è¿‡åŒæ­¥"
          fi
          
      - name: ðŸ“‹ Summary Report
        run: |
          echo "## ðŸŽ‰ Wiki åŒæ­¥å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š åŒæ­¥ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **æºæäº¤**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š åŒæ­¥çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la docs/*.md 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ° .md æ–‡ä»¶"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— è®¿é—®é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“– æŸ¥çœ‹ Wiki](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‚ æŸ¥çœ‹æºæ–‡æ¡£](https://github.com/${{ github.repository }}/tree/main/docs)" >> $GITHUB_STEP_SUMMARY