#!/bin/bash

# ğŸ”„ è‡ªåŠ¨åŒæ­¥ docs/ åˆ° GitHub Wiki
# éœ€è¦å…ˆåœ¨ Web ç•Œé¢åˆ›å»º Wiki é¦–é¡µæ¥åˆå§‹åŒ–ä»“åº“

echo "ğŸ”„ å¼€å§‹åŒæ­¥ docs/ åˆ° GitHub Wiki..."

# é…ç½®
WIKI_REPO="https://github.com/greddy7574/taigaMcpServer.wiki.git"
TEMP_DIR="temp-wiki-sync"

# æ¸…ç†æ—§çš„ä¸´æ—¶ç›®å½•
if [ -d "$TEMP_DIR" ]; then
    echo "ğŸ§¹ æ¸…ç†æ—§ä¸´æ—¶ç›®å½•..."
    rm -rf "$TEMP_DIR"
fi

# å…‹éš† Wiki ä»“åº“
echo "ğŸ“¥ å…‹éš† Wiki ä»“åº“..."
if git clone "$WIKI_REPO" "$TEMP_DIR"; then
    echo "âœ… Wiki ä»“åº“å…‹éš†æˆåŠŸ"
else
    echo "âŒ Wiki ä»“åº“å…‹éš†å¤±è´¥ - è¯·å…ˆåœ¨ Web ç•Œé¢åˆ›å»º Wiki é¦–é¡µ"
    echo "   è®¿é—®: https://github.com/greddy7574/taigaMcpServer/wiki"
    echo "   ç‚¹å‡» 'Create the first page' å¹¶ä¿å­˜ä»»æ„å†…å®¹"
    exit 1
fi

cd "$TEMP_DIR"

# å¤‡ä»½ç°æœ‰å†…å®¹
echo "ğŸ’¾ å¤‡ä»½ç°æœ‰ Wiki å†…å®¹..."
mkdir -p ../wiki-backup
cp -r * ../wiki-backup/ 2>/dev/null || true

# æ¸…ç† Wiki ç›®å½•ï¼ˆä¿ç•™ .gitï¼‰
echo "ğŸ§¹ æ¸…ç† Wiki ç›®å½•..."
find . -type f -not -path './.git/*' -delete

# è½¬æ¢ docs/ å†…å®¹ä¸º Wiki æ ¼å¼
echo "ğŸ”„ è½¬æ¢æ–‡æ¡£æ ¼å¼..."

# å¤åˆ¶æ–‡æ¡£æ–‡ä»¶
cp ../docs/README.md ./Home.md

# åˆ›å»ºä¾§è¾¹æ 
cat > _Sidebar.md << 'EOF'
## ğŸš€ Taiga MCP Server

### âš¡ å¿«é€Ÿå¼€å§‹
* [[Home|é¦–é¡µ]]
* [[Installation Guide|å®‰è£…æŒ‡å—]]
* [[Configuration|é…ç½®]]
* [[First Steps|ç¬¬ä¸€æ­¥]]

### ğŸ“‹ API æ–‡æ¡£
* [[API Reference|API å‚è€ƒ]]
* [[Authentication|è®¤è¯]]
* [[Projects|é¡¹ç›®]]
* [[Sprints|Sprint]]
* [[Issues|é—®é¢˜]]

### ğŸ› ï¸ å¼€å‘æŒ‡å—
* [[CI CD Guide|CI/CD æŒ‡å—]]
* [[Development|å¼€å‘ç¯å¢ƒ]]
* [[Testing|æµ‹è¯•]]
* [[Troubleshooting|æ•…éšœæ’é™¤]]

### ğŸ—ï¸ æ¶æ„
* [[Architecture Overview|æ¶æ„æ¦‚è§ˆ]]
* [[Design|è®¾è®¡æ–‡æ¡£]]
* [[Modules|æ¨¡å—è®¾è®¡]]

---
**GitHub**: [æºç ä»“åº“](https://github.com/greddy7574/taigaMcpServer)
EOF

# å¤åˆ¶å’Œè½¬æ¢å„ä¸ªæ–‡æ¡£æ–‡ä»¶
echo "ğŸ“ å¤åˆ¶æ–‡æ¡£æ–‡ä»¶..."

# Getting Started
cp ../docs/getting-started/installation.md "Installation-Guide.md"
cp ../docs/getting-started/configuration.md "Configuration.md" 
cp ../docs/getting-started/first-steps.md "First-Steps.md"

# API docs (å¦‚æœå­˜åœ¨)
if [ -f "../docs/api/README.md" ]; then
    cp ../docs/api/README.md "API-Reference.md"
fi

# Guides (å¦‚æœå­˜åœ¨)
if [ -f "../docs/guides/ci-cd.md" ]; then
    cp ../docs/guides/ci-cd.md "CI-CD-Guide.md"
fi

# Architecture (å¦‚æœå­˜åœ¨)
if [ -f "../docs/architecture/overview.md" ]; then
    cp ../docs/architecture/overview.md "Architecture-Overview.md"
fi
if [ -f "../docs/architecture/design.md" ]; then
    cp ../docs/architecture/design.md "Design.md"
fi

# ä¿®å¤ Wiki å†…éƒ¨é“¾æ¥
echo "ğŸ”— ä¿®å¤å†…éƒ¨é“¾æ¥..."
for file in *.md; do
    if [ -f "$file" ]; then
        # è½¬æ¢ç›¸å¯¹é“¾æ¥ä¸º Wiki é“¾æ¥
        sed -i.bak 's/](getting-started\/installation\.md)/](Installation-Guide)/g' "$file"
        sed -i.bak 's/](getting-started\/configuration\.md)/](Configuration)/g' "$file"
        sed -i.bak 's/](getting-started\/first-steps\.md)/](First-Steps)/g' "$file"
        sed -i.bak 's/](api\/README\.md)/](API-Reference)/g' "$file"
        sed -i.bak 's/](guides\/ci-cd\.md)/](CI-CD-Guide)/g' "$file"
        sed -i.bak 's/](architecture\/overview\.md)/](Architecture-Overview)/g' "$file"
        sed -i.bak 's/](architecture\/design\.md)/](Design)/g' "$file"
        
        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f "$file.bak"
    fi
done

# æäº¤æ›´æ”¹
echo "ğŸ’¾ æäº¤ Wiki æ›´æ”¹..."
git add .
git commit -m "Auto-sync from docs/ directory

ğŸ“š Synchronized Documentation:
- Updated from main repository docs/ directory
- Converted relative links to Wiki format
- Created structured navigation sidebar
- Maintained all documentation content

ğŸ”„ Sync Date: $(date)
ğŸ¤– Auto-generated by sync script"

# æ¨é€åˆ° Wiki
echo "ğŸš€ æ¨é€åˆ° GitHub Wiki..."
git push origin master

# è¿”å›ä¸»ç›®å½•å¹¶æ¸…ç†
cd ..
rm -rf "$TEMP_DIR"

echo ""
echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
echo "ğŸ“– è®¿é—® Wiki: https://github.com/greddy7574/taigaMcpServer/wiki"
echo "ğŸ”„ æ‰€æœ‰ docs/ å†…å®¹å·²åŒæ­¥åˆ° Wiki"
echo ""
echo "ğŸ“‹ åŒæ­¥çš„é¡µé¢ï¼š"
echo "   â€¢ Home (é¦–é¡µ)"
echo "   â€¢ Installation Guide (å®‰è£…æŒ‡å—)"  
echo "   â€¢ Configuration (é…ç½®)"
echo "   â€¢ First Steps (ç¬¬ä¸€æ­¥)"
echo "   â€¢ API Reference (API å‚è€ƒ)"
echo "   â€¢ CI/CD Guide (CI/CD æŒ‡å—)"
echo "   â€¢ Architecture Overview (æ¶æ„æ¦‚è§ˆ)"
echo ""
echo "ğŸ’¡ æç¤º: è¿è¡Œæ­¤è„šæœ¬å¯ä»¥éšæ—¶åŒæ­¥æœ€æ–°çš„æ–‡æ¡£æ›´æ”¹åˆ° Wikiï¼"